
<!-- Top Nav Bar -->
<nav class="top-nav">
  <div class="brand">AccountTrack — Bank Officer</div>
  <ul class="nav-links">
    <li [class.active]="activeTab === 'create'">
      <button (click)="activeTab='create'">Create Bank Account</button>
    </li>
    <li [class.active]="activeTab === 'update'">
      <button (click)="activeTab='update'">Update Bank Account</button>
    </li>
    <li [class.active]="activeTab === 'history'">
      <button (click)="activeTab='history'">Transaction History</button>
    </li>
  </ul>
</nav>

<section class="container">
  <!-- Alerts -->
  <div *ngIf="alert.message" class="alert" [class.error]="alert.type==='error'" [class.success]="alert.type==='success'">
    {{ alert.message }}
    <button class="close" (click)="clearAlert()">×</button>
  </div>

  <!-- CREATE ACCOUNT -->
  <div *ngIf="activeTab==='create'" class="card">
    <h2>Create Bank Account</h2>
    <form [formGroup]="createForm" (ngSubmit)="createAccount()">
      <div class="grid">
        <label>
          Account ID
          <input type="text" formControlName="accountId" placeholder="Enter Account ID" />
        </label>
        <label>
          Customer Name
          <input type="text" formControlName="customerName" placeholder="Enter Customer Name" />
        </label>
        <label>
          Customer ID
          <input type="text" formControlName="customerId" placeholder="Enter Customer ID" />
        </label>
        <label>
          Account Type
          <select formControlName="accountType">
            <option value="SAVINGS">Savings</option>
            <option value="CURRENT">Current</option>
          </select>
        </label>
        <label>
          Balance
          <input type="number" formControlName="balance" min="0" step="0.01" />
        </label>
        <label>
          Status
          <select formControlName="status">
            <option value="ACTIVE">Active</option>
            <option value="CLOSED">Closed</option>
          </select>
        </label>
      </div>

      <div class="actions">
        <button class="primary" type="submit" [disabled]="createForm.invalid">Create Account</button>
        <button type="button" class="secondary" (click)="createForm.reset(defaultCreateForm())">Reset</button>
      </div>

      <div class="helper" *ngIf="createForm.invalid">
        <small>All fields are required. Balance must be ≥ 0.</small>
      </div>
    </form>

    <hr />
    <h3>Existing Accounts ({{ accounts.length }})</h3>
    <div class="table-wrap" *ngIf="accounts.length; else noAccounts">
      <table>
        <thead>
          <tr>
            <th>Account ID</th>
            <th>Customer Name</th>
            <th>Customer ID</th>
            <th>Type</th>
            <th>Status</th>
            <th>Balance</th>
            <th>Opened</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let a of accounts">
            <td>{{ a.accountId }}</td>
            <td>{{ a.customerName }}</td>
            <td>{{ a.customerId }}</td>
            <td>{{ a.accountType }}</td>
            <td><span class="pill" [class.ok]="a.status==='ACTIVE'" [class.bad]="a.status==='CLOSED'">{{ a.status }}</span></td>
            <td>{{ a.balance | number:'1.2-2' }}</td>
            <td>{{ a.openedAt | date:'medium' }}</td>
            <td>
              <button class="link" (click)="prefillUpdate(a.accountId)">Edit</button>
              <button class="link" (click)="goToHistory(a.accountId)">Txns</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noAccounts>
      <p class="muted">No accounts yet. Create one using the form above.</p>
    </ng-template>
  </div>

  <!-- UPDATE ACCOUNT -->
  <div *ngIf="activeTab==='update'" class="card">
    <h2>Update Bank Account</h2>

    <div class="inline">
      <input class="inline-input" [(ngModel)]="lookupAccountId" placeholder="Enter Account ID" />
      <button class="secondary" (click)="prefillUpdate(lookupAccountId)">Load</button>
    </div>

    <form [formGroup]="updateForm" (ngSubmit)="updateAccount()" *ngIf="updateFormLoaded; else noLoad">
      <div class="grid">
        <label>
          Account ID
          <input type="text" formControlName="accountId" readonly />
        </label>
        <label>
          Customer Name
          <input type="text" formControlName="customerName" />
        </label>
        <label>
          Customer ID
          <input type="text" formControlName="customerId" />
        </label>
        <label>
          Account Type
          <select formControlName="accountType">
            <option value="SAVINGS">Savings</option>
            <option value="CURRENT">Current</option>
          </select>
        </label>
        <label>
          Balance (admin adjustment)
          <input type="number" formControlName="balance" min="0" step="0.01" />
        </label>
        <label>
          Status
          <select formControlName="status">
            <option value="ACTIVE">Active</option>
            <option value="CLOSED">Closed</option>
          </select>
        </label>
      </div>

      <div class="actions">
        <button class="primary" type="submit" [disabled]="updateForm.invalid">Update Account</button>
        <button type="button" class="secondary" (click)="updateForm.reset(); updateFormLoaded=false">Cancel</button>
      </div>
    </form>

    <ng-template #noLoad>
      <p class="muted">Enter an Account ID and click <b>Load</b> to edit.</p>
    </ng-template>
  </div>

  <!-- TRANSACTION HISTORY & RECORD -->
  <div *ngIf="activeTab==='history'" class="card">
    <h2>Transaction History</h2>

    <div class="grid narrow">
      <label>
        Select Account
        <select [(ngModel)]="selectedHistoryAccountId">
          <option [ngValue]="undefined">— Select —</option>
          <option *ngFor="let a of accounts" [ngValue]="a.accountId">{{ a.accountId }} — {{ a.customerName }}</option>
        </select>
      </label>

      <label>
        High-Value Threshold
        <input type="number" [(ngModel)]="highValueThreshold" min="0" step="1" />
      </label>

      <div class="inline">
        <button class="secondary" (click)="goToCreate()">New Account</button>
        <button class="secondary" (click)="prefillUpdate(selectedHistoryAccountId!)" [disabled]="!selectedHistoryAccountId">Edit Account</button>
      </div>
    </div>

    <!-- Record Transaction -->
    <div class="card subtle" *ngIf="selectedHistoryAccountId as accId">
      <h3>Record Transaction ({{ accId }})</h3>
      <form [formGroup]="txnForm" (ngSubmit)="recordTransaction()">
        <div class="grid narrow">
          <label>
            Type
            <select formControlName="type" (change)="onTxnTypeChange()">
              <option value="DEPOSIT">Deposit</option>
              <option value="WITHDRAWAL">Withdrawal</option>
              <option value="TRANSFER">Transfer</option>
            </select>
          </label>

          <label>
            Amount
            <input type="number" formControlName="amount" min="0.01" step="0.01" />
          </label>

          <label *ngIf="txnForm.value.type==='TRANSFER'">
            To Account ID
            <select formControlName="toAccountId">
              <option [ngValue]="undefined">— Select —</option>
              <option *ngFor="let a of accounts" [ngValue]="a.accountId" [disabled]="a.accountId===selectedHistoryAccountId">
                {{ a.accountId }} — {{ a.customerName }}
              </option>
            </select>
          </label>

          <label>
            Narrative (optional)
            <input type="text" formControlName="narrative" maxlength="140" placeholder="e.g., Salary credit / ATM withdrawal" />
          </label>
        </div>

        <div class="actions">
          <button class="primary" type="submit" [disabled]="txnForm.invalid">Record</button>
          <button class="secondary" type="button" (click)="resetTxnForm()">Reset</button>
        </div>
        <small class="muted">Closed accounts cannot receive transactions. Withdrawals/transfers require sufficient balance.</small>
      </form>
    </div>

    <!-- History Table -->
    <div class="table-wrap" *ngIf="selectedHistoryAccountId && transactionsFor(selectedHistoryAccountId).length; else noTxns">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Type</th>
            <th>Amount</th>
            <th>From</th>
            <th>To</th>
            <th>Flagged</th>
            <th>Narrative</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let t of transactionsFor(selectedHistoryAccountId)">
            <td>{{ t.time | date:'medium' }}</td>
            <td>{{ t.type }}</td>
            <td [class.red]="t.type==='WITHDRAWAL' || (t.type==='TRANSFER' && t.accountId===selectedHistoryAccountId)">
              {{ t.amount | number:'1.2-2' }}
            </td>
            <td>{{ t.accountId }}</td>
            <td>{{ t.toAccountId || '—' }}</td>
            <td>
              <span class="pill" [class.ok]="t.flagged" [class.bad]="!t.flagged">{{ t.flagged ? 'HIGH' : 'Normal' }}</span>
            </td>
            <td>{{ t.narrative || '—' }}</td>
            <td>
              <button class="link" (click)="flagTransaction(t)" [disabled]="t.flagged">Flag</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noTxns>
      <p class="muted" *ngIf="selectedHistoryAccountId">No transactions yet for {{ selectedHistoryAccountId }}.</p>
      <p class="muted" *ngIf="!selectedHistoryAccountId">Select an account to view history.</p>
    </ng-template>
  </div>
</section>
