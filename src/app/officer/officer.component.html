
<!-- Top Navigation Bar -->
<nav class="top-nav" (click)="$event.stopPropagation()" role="navigation" aria-label="Primary">
  <div class="brand">
    <a class="navbar-brand d-flex align-items-center" href="" aria-label="MyBank Home">
      <!-- Dummy SVG logo -->
      <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"
           class="bi bi-bank me-2" viewBox="0 0 16 16" aria-hidden="true">
        <path d="M8 .95l6.364 3.182v1.09H1.636v-1.09L8 .95zm0 1.09L2.636 5.223h10.728L8 2.04zM1 6h14v1H1V6zm1 2h1v6H2V8zm2 0h1v6H4V8zm2 0h1v6H6V8zm2 0h1v6H8V8zm2 0h1v6h-1V8zm2 0h1v6h-1V8zm2 0h1v6h-1V8z"/>
      </svg>
      <span class="fw-bold" id="logo-text">MyBank</span>
    </a>
  </div>

  <!-- Desktop nav links -->
  <ul class="nav-links">
    <li [class.active]="activeTab === 'create'">
      <button type="button" (click)="goToCreate()">Create Bank Account</button>
    </li>
    <li [class.active]="activeTab === 'update'">
      <button type="button" (click)="activeTab='update'">Update Bank Account</button>
    </li>
    <li [class.active]="activeTab === 'history'">
      <button type="button" (click)="activeTab='history'">Transaction History</button>
    </li>
  </ul>

  <!-- Hamburger (mobile) -->
  <button
    class="hamburger"
    type="button"
    aria-label="Toggle navigation"
    [attr.aria-expanded]="isMobileNavOpen"
    aria-controls="mobileMenu"
    (click)="toggleMobileNav($event)">
    <span></span><span></span><span></span>
  </button>

  <!-- Profile Dropdown (Desktop) -->
  <div class="position-relative profile-desktop" *ngIf="currentUser">
    <button
      class="btn btn-transparent d-flex align-items-center gap-2 p-0"
      type="button"
      data-bs-toggle="dropdown"
      aria-expanded="false"
      (click)="$event.stopPropagation(); isProfileMenuOpen = !isProfileMenuOpen">
      <span
        class="avatar-initials bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
        style="width:36px;height:36px;font-size:0.9rem;"
        aria-hidden="true">
        {{ initials(currentUser.name) }}
      </span>

      <span class="text-white fw-semibold d-none d-md-inline">
        {{ currentUser.name }}
      </span>
    </button>

    <ul class="dropdown-menu dropdown-menu-end text-sm" [class.show]="isProfileMenuOpen">
      <li class="px-3 py-2">
        <div class="small text-muted">Signed in as</div>
        <div class="fw-semibold">{{ currentUser.name }}</div>
        <div class="text-muted text-truncate" style="max-width:220px;">
          {{ currentUser.email }}
        </div>
      </li>

      <li><hr class="dropdown-divider"></li>

      <li class="px-3 py-2">
        <div class="small text-muted">Role</div>
        <div class="fw-semibold">{{ currentUser.role }}</div>
      </li>

      <li class="px-3 py-2">
        <div class="small text-muted">Branch</div>
        <div class="fw-semibold">{{ currentUser.branch }}</div>
      </li>

      <li><hr class="dropdown-divider"></li>

      <li>
        <button
          class="dropdown-item"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasOfficerProfile">
          View full profile
        </button>
      </li>

      <li>
        <button class="dropdown-item text-danger" type="button" (click)="logout($event)">
          Sign out
        </button>
      </li>
    </ul>
  </div>
</nav>

<!-- Mobile Menu -->
<div
  id="mobileMenu"
  class="mobile-nav"
  *ngIf="isMobileNavOpen"
  (click)="$event.stopPropagation()"
  role="dialog"
  aria-modal="true"
  aria-label="Mobile navigation">
  <div class="mobile-nav-group">
    <button type="button" class="mobile-link" [class.active]="activeTab==='create'" (click)="goToCreate()">Create Bank Account</button>
    <button type="button" class="mobile-link" [class.active]="activeTab==='update'" (click)="activeTab='update'; closeMobileNav()">Update Bank Account</button>
    <button type="button" class="mobile-link" [class.active]="activeTab==='history'" (click)="activeTab='history'; closeMobileNav()">Transaction History</button>
  </div>

  <div class="mobile-divider"></div>

  <div class="mobile-profile" *ngIf="currentUser">
    <div class="row1">
      <div
        class="avatar-initials bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
        style="width:36px;height:36px;font-size:0.9rem;"
        aria-hidden="true">
        {{ initials(currentUser.name) }}
      </div>
      <div class="info">
        <div class="name">{{ currentUser.name }}</div>
        <div class="email">{{ currentUser.email }}</div>
      </div>
    </div>
    <div class="row2">
      <button
        class="mobile-link"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasOfficerProfile"
        (click)="closeMobileNav()">
        View full profile
      </button>
      <button class="mobile-link danger" type="button" (click)="logout($event)">Sign out</button>
    </div>
  </div>
</div>

<section class="container">
  <!-- Alerts -->
  <div *ngIf="alert.message"
       class="console-alert"
       [class.error]="alert.type==='error'"
       [class.success]="alert.type==='success'"
       role="alert"
       aria-live="assertive">
    <span class="msg">{{ alert.message }}</span>
    <button class="close" (click)="clearAlert()" style="color: aliceblue;" aria-label="Close alert">
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="12" fill="rgba(255, 255, 255, 0.7)"/>
        <path d="M8 8 L16 16 M16 8 L8 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <!-- CREATE ACCOUNT -->
  <div *ngIf="activeTab==='create'" class="card">
    <header class="card-header"><h2>Create Bank Account</h2></header>

    <!-- account creation form -->
    <form [formGroup]="createForm" (ngSubmit)="createAccount()" class="responsive-form" novalidate>
      <div class="grid">
        <label>
          Account ID
          <input type="text" formControlName="accountId" placeholder="Enter Account ID" />
          <div class="error"
               *ngIf="createForm.get('accountId')?.invalid && (createForm.get('accountId')?.touched || submitted)">
            <small *ngIf="createForm.get('accountId')?.errors?.['required']" class="err-text">Account ID is required!</small>
            <small *ngIf="createForm.get('accountId')?.errors?.['minlength']" class="err-text">Account ID must be at least 3 characters!</small>
          </div>
        </label>

        <label>
          Customer Name
          <input type="text" formControlName="customerName" placeholder="Enter Customer Name" />
          <div class="error"
               *ngIf="createForm.get('customerName')?.invalid && (createForm.get('customerName')?.touched || submitted)">
            <small *ngIf="createForm.get('customerName')?.errors?.['required']" class="err-text">Customer Name is required!</small>
          </div>
        </label>

        <label>
          Customer ID
          <input type="text" formControlName="customerId" placeholder="Enter Customer ID" />
          <div class="error"
               *ngIf="createForm.get('customerId')?.invalid && (createForm.get('customerId')?.touched || submitted)">
            <small *ngIf="createForm.get('customerId')?.errors?.['required']" class="err-text">Customer ID is required!</small>
          </div>
        </label>

        <label>
          Account Type
          <select formControlName="accountType">
            <option value="SAVINGS">Savings</option>
            <option value="CURRENT">Current</option>
          </select>
          <div class="error"
               *ngIf="createForm.get('accountType')?.invalid && (createForm.get('accountType')?.touched || submitted)">
            <small *ngIf="createForm.get('accountType')?.errors?.['required']" class="err-text">Account Type is required!</small>
          </div>
        </label>
      </div>
      <br>
      <div class="actions">
        <button class="primary" type="submit">Create Account</button>
        <button type="button" class="secondary" (click)="createForm.reset(defaultCreateForm()); submitted=false">
          Reset
        </button>
      </div>

      <!-- Optional overall helper shown after submit if invalid -->
      <div class="helper" *ngIf="submitted && createForm.invalid">
        <small>There are errors above. Please fix them to continue.</small>
      </div>
    </form>

    <hr />
    <h3>Existing Accounts ({{ accounts.length }})</h3><br>
    <div class="table-wrap" *ngIf="accounts.length; else noAccountsCreate">
      <table class="scroll-table">
        <thead>
          <tr>
            <th scope="col">Account ID</th>
            <th scope="col">Customer Name</th>
            <th scope="col">Customer ID</th>
            <th scope="col">Type</th>
            <th scope="col">Status</th>
            <th scope="col">Opened</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let a of accounts">
            <td [attr.data-label]="'Account ID'">{{ a.accountId }}</td>
            <td [attr.data-label]="'Customer Name'">{{ a.customerName }}</td>
            <td [attr.data-label]="'Customer ID'">{{ a.customerId }}</td>
            <td [attr.data-label]="'Type'">{{ a.accountType }}</td>
            <td [attr.data-label]="'Status'">
              <span class="pill" [class.ok]="a.status==='ACTIVE'" [class.bad]="a.status==='CLOSED'">
                {{ a.status }}
              </span>
            </td>
            <td [attr.data-label]="'Opened'">{{ a.openedAt | date:'medium' }}</td>
            <td [attr.data-label]="'Actions'">
              <button class="link" (click)="prefillUpdate(a.accountId)">Edit</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noAccountsCreate>
      <p class="muted">No accounts yet. Create one using the form above.</p>
    </ng-template>
  </div>

  <!-- UPDATE ACCOUNT -->
  <div *ngIf="activeTab==='update'" class="card">
    <h2>Update Bank Account</h2>

    <div class="inline">
      <input class="inline-input" [(ngModel)]="lookupAccountId" placeholder="Enter Account ID" [ngModelOptions]="{standalone:true}" />
      <button class="secondary" (click)="prefillUpdate(lookupAccountId)">Load</button>
    </div>

    <form [formGroup]="updateForm" (ngSubmit)="updateAccount()" *ngIf="updateFormLoaded" class="responsive-form" novalidate>
      <div class="grid">
        <label>
          Account ID
          <input type="text" formControlName="accountId" readonly />
        </label>
        <label>
          Customer Name
          <input type="text" formControlName="customerName" />
        </label>
        <label>
          Customer ID
          <input type="text" formControlName="customerId" />
        </label>
        <label>
          Account Type
          <select formControlName="accountType">
            <option value="SAVINGS">Savings</option>
            <option value="CURRENT">Current</option>
          </select>
        </label>
        <label>
          Balance (admin adjustment)
          <input type="number" formControlName="balance" min="0" step="0.01" />
        </label>
        <label>
          Status
          <select formControlName="status">
            <option value="ACTIVE">Active</option>
            <option value="CLOSED">Closed</option>
          </select>
        </label>
      </div><br>

      <div class="actions">
        <button class="primary" type="submit" [disabled]="updateForm.invalid">Submit Update Request</button>
        <button type="button" class="secondary" (click)="updateForm.reset(); updateFormLoaded=false">Cancel</button>
      </div>
    </form>
    <hr />

    <!-- ðŸ”¹ UPDATION STATUS TABLE -->
    <h3>Updation Status</h3><br>

    <div class="table-wrap" *ngIf="updateRequests && updateRequests.length > 0; else noUpdates">
      <table class="scroll-table">
        <thead>
          <tr>
            <th scope="col">Update ID</th>
            <th scope="col">Account ID</th>
            <th scope="col">Customer Name</th>
            <th scope="col">Customer ID</th>
            <th scope="col">Type</th>
            <th scope="col">Changes Summary</th>
            <th scope="col">Status</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let u of updateRequests">
            <td [attr.data-label]="'Update ID'">{{ u.updateId }}</td>
            <td [attr.data-label]="'Account ID'">{{ u.accountId }}</td>
            <td [attr.data-label]="'Customer Name'">{{ u.customerName }}</td>
            <td [attr.data-label]="'Customer ID'">{{ u.customerId }}</td>
            <td [attr.data-label]="'Type'">{{ u.accountType }}</td>
            <td [attr.data-label]="'Changes Summary'">{{ u.changeSummary }}</td>
            <td [attr.data-label]="'Status'">
              <span class="pill bad">{{ u.status }}</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #noUpdates>
      <p class="muted">No update requests submitted yet.</p>
    </ng-template>
  </div>

  <!-- ================= TRANSACTION TAB ================= -->
  <div *ngIf="activeTab==='history'" class="card">
    <h2>Transaction Management</h2><br>

    <!-- ===== SECTION 1: RECORD TRANSACTION ===== -->
    <div class="card subtle">
      <h3>Record Transaction</h3>

      <form [formGroup]="txnForm" (ngSubmit)="recordTransaction()" class="responsive-form" novalidate>
        <div class="grid-narrow">
          <!-- Account Select -->
          <label>
            Account ID
            <!-- Keep ngModel standalone while inside reactive form -->
            <select [(ngModel)]="selectedHistoryAccountId" [ngModelOptions]="{ standalone: true }" name="txnAcc">
              <option [ngValue]="undefined">â€” Select Account â€”</option>
              <option *ngFor="let a of accounts" [ngValue]="a.accountId">
                {{ a.accountId }} â€” {{ a.customerName }}
              </option>
            </select>
          </label>

          <!-- Threshold -->
          <label>
            High Value Threshold (â‚¹)
            <input type="number" [value]="highValueThreshold" disabled />
          </label>

          <!-- Type -->
          <label>
            Transaction Type
            <select formControlName="type" (change)="onTxnTypeChange()">
              <option value="DEPOSIT">Deposit</option>
              <option value="WITHDRAWAL">Withdrawal</option>
              <option value="TRANSFER">Transfer</option>
            </select>
          </label>

          <!-- Amount -->
          <label>
            Amount
            <input type="number" formControlName="amount" min="0.01" />
          </label>

          <!-- Transfer Account -->
          <label *ngIf="txnForm.value.type==='TRANSFER'">
            To Account ID
            <select formControlName="toAccountId">
              <option [ngValue]="undefined">â€” Select â€”</option>
              <option *ngFor="let a of accounts"
                      [ngValue]="a.accountId"
                      [disabled]="a.accountId===selectedHistoryAccountId">
                {{ a.accountId }} â€” {{ a.customerName }}
              </option>
            </select>
          </label>

          <!-- Narrative -->
          <label>
            Narrative
            <input type="text" formControlName="narrative" placeholder="Optional note" />
          </label>
        </div>
        <br>

        <div class="actions">
          <button class="primary" type="submit"
                  [disabled]="txnForm.invalid || !selectedHistoryAccountId">
            Record Transaction
          </button>
          <button class="secondary" type="button" (click)="resetTxnForm()">Reset</button>
        </div>
      </form>
    </div>

    <br />

    <!-- ===== SECTION 2: TRANSACTION HISTORY ===== -->
    <div class="card">
      <h3>Transaction History</h3>

      <!-- Filters -->
      <div class="grid narrow">
        <label>
          Account ID
          <select [(ngModel)]="historyFilterAccountId" [ngModelOptions]="{ standalone: true }">
            <option [ngValue]="undefined">â€” All Accounts â€”</option>
            <option *ngFor="let a of accounts" [ngValue]="a.accountId">
              {{ a.accountId }} â€” {{ a.customerName }}
            </option>
          </select>
        </label>

        <label>
          From Date
          <input type="date" [(ngModel)]="fromDate" [ngModelOptions]="{ standalone: true }"/>
        </label>

        <label>
          To Date
          <input type="date" [(ngModel)]="toDate" [ngModelOptions]="{ standalone: true }"/>
        </label>
      </div>

      <br />

      <!-- Table -->
      <div class="table-wrap" *ngIf="filteredTransactions().length; else noTx">
        <table class="scroll-table">
          <thead>
            <tr>
              <th scope="col">Transaction ID</th>
              <th scope="col">Account ID</th>
              <th scope="col">Type</th>
              <th scope="col">Amount</th>
              <th scope="col">Date</th>
              <th scope="col">Status</th>
              <th scope="col">Flag</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of filteredTransactions()">
              <td [attr.data-label]="'Transaction ID'">{{ t.id }}</td>
              <td [attr.data-label]="'Account ID'">{{ t.accountId }}</td>
              <td [attr.data-label]="'Type'">{{ t.type }}</td>
              <td [attr.data-label]="'Amount'">â‚¹{{ t.amount | number:'1.2-2' }}</td>
              <td [attr.data-label]="'Date'">{{ t.time | date:'medium' }}</td>
              <td [attr.data-label]="'Status'">
                <span class="pill"
                      [class.ok]="t.amount < highValueThreshold"
                      [class.bad]="t.amount >= highValueThreshold">
                  {{ t.amount < highValueThreshold ? 'Completed' : 'Pending' }}
                </span>
              </td>
              <td [attr.data-label]="'Flag'">
                <span class="pill" [class.bad]="t.flagged" [class.ok]="!t.flagged">
                  {{ t.flagged ? 'High' : 'Normal' }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #noTx>
        <p class="muted">No transactions found for selected filters.</p>
      </ng-template>
    </div>
  </div>

  <!-- Officer Profile Offcanvas -->
  <div
    class="offcanvas offcanvas-end text-bg-dark"
    tabindex="-1"
    id="offcanvasOfficerProfile"
  >
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">My Profile</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body">
      <div class="d-flex align-items-center gap-3 mb-3">
        <div
          class="avatar-initials bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
          style="width:48px;height:48px;font-size:1rem;"
          aria-hidden="true">
          {{ initials(currentUser?.name || '') }}
        </div>

        <div>
          <div class="fw-semibold fs-5">{{ currentUser?.name }}</div>
          <div class="text-muted">{{ currentUser?.email }}</div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-6">
          <div class="text-muted small">User ID</div>
          <div class="fw-semibold">{{ currentUser?.userId }}</div>
        </div>

        <div class="col-6">
          <div class="text-muted small">Role</div>
          <div class="fw-semibold">{{ currentUser?.role }}</div>
        </div>

        <div class="col-6">
          <div class="text-muted small">Branch</div>
          <div class="fw-semibold">{{ currentUser?.branch }}</div>
        </div>

        <div class="col-6">
          <div class="text-muted small">Status</div>
          <span class="badge bg-success">Active</span>
        </div>
      </div>

      <div class="mt-4 d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" data-bs-dismiss="offcanvas">
          Close
        </button>
      </div>
    </div>
  </div>
</section>
