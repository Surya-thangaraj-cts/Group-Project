
<!-- Admin Console Page -->
<div class="py-3 admin-page" oncontextmenu="return false">
  <!-- ===== Header (Profile + toggles) ===== -->
  <div class="mb-3 header">
    <div class="d-flex align-items-center justify-content-between gap-3">
      <div>
        <h1 class="h4 mb-1">
          <!-- Title changes based on active view -->
          <ng-container *ngIf="activeView === 'admin'; else complTitle">Admin Console</ng-container>
          <ng-template #complTitle>Compliance Dashboard</ng-template>
        </h1>
        <p class="mb-0">
          <ng-container *ngIf="activeView === 'admin'; else complSubtitle">
            User management &amp; compliance metrics
          </ng-container>
          <ng-template #complSubtitle>
            Transactions, flags, and distribution
          </ng-template>
        </p>
      </div>

      <div class="d-flex align-items-center gap-2 flex-wrap">
        <!-- Toggle Admin/Compliance -->
        <button
          *ngIf="activeView === 'admin'; else backToAdminBtn"
          class="btn btn-outline-light btn-sm"
          type="button"
          (click)="showCompliance()"
          title="Open Compliance Dashboard"
        >
          View Compliance Metrics
        </button>
        <ng-template #backToAdminBtn>
          <button
            class="btn btn-outline-light btn-sm"
            type="button"
            (click)="showAdmin()"
            title="Back to Admin Console"
          >
            Back to Admin Console
          </button>
        </ng-template>

        <!-- Existing Users button visible on both Admin & Compliance -->
        <button
          *ngIf="!(activeView === 'admin' && showExistingOnly); else backToFull"
          class="btn btn-warning btn-sm"
          type="button"
          (click)="openExistingUsers()"
          title="Show only Existing Users"
        >
          Existing Users
        </button>
        <ng-template #backToFull>
          <button
            class="btn btn-outline-warning btn-sm"
            type="button"
            (click)="showFullAdmin()"
            title="Back to full Admin"
          >
            Back to Admin
          </button>
        </ng-template>

        <!-- Profile dropdown -->
        <div class="position-relative ms-1">
          <button
            class="btn btn-transparent d-flex align-items-center gap-2 p-0"
            type="button"
            id="headerProfileDropdown"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <span
              class="avatar-initials bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
              style="width:36px;height:36px;font-size:0.9rem;"
            >
              {{ initials(currentUser?.name ?? '') }}
            </span>
            <span class="d-none d-md-inline text-white fw-semibold">{{ currentUser?.name || 'User' }}</span>
          </button>

          <ul class="dropdown-menu dropdown-menu-end text-sm" aria-labelledby="headerProfileDropdown">
            <li class="px-3 py-2">
              <div class="small text-muted mb-1">Signed in as</div>
              <div class="fw-semibold">{{ currentUser?.name || 'Unknown User' }}</div>
              <div class="text-muted text-truncate" style="max-width:220px;">
                {{ currentUser?.email || '' }}
              </div>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li class="px-3 py-2">
              <div class="small text-muted">Role</div>
              <div class="fw-semibold">{{ currentUser?.role || '' }}</div>
            </li>
            <li class="px-3 py-2">
              <div class="small text-muted">Branch</div>
              <div class="fw-semibold">{{ currentUser?.branch || '' }}</div>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <button
                class="dropdown-item"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasProfile"
                (click)="selectUser(currentUser!)"
              >
                View full profile
              </button>
            </li>
            <li>
              <button class="dropdown-item" type="button" (click)="signOut()">Sign out</button>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Offcanvas: Full Profile ===== -->
  <div
    class="offcanvas offcanvas-end text-bg-dark"
    tabindex="-1"
    id="offcanvasProfile"
    aria-labelledby="offcanvasProfileLabel"
  >
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasProfileLabel">My Profile</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="d-flex align-items-center gap-3 mb-3">
        <div
          class="avatar-initials bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
          style="width:48px;height:48px;font-size:1rem;"
        >
          {{ initials(currentUser?.name ?? '') }}
        </div>
        <div>
          <div class="fw-semibold fs-5">{{ currentUser?.name || 'Unknown User' }}</div>
          <div class="text-muted">{{ currentUser?.email || '' }}</div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <div class="text-muted small">User ID</div>
          <div class="fw-semibold">{{ currentUser?.userId || '' }}</div>
        </div>
        <div class="col-12 col-md-6">
          <div class="text-muted small">Role</div>
          <div class="fw-semibold">{{ currentUser?.role || '' }}</div>
        </div>
        <div class="col-12 col-md-6">
          <div class="text-muted small">Branch</div>
          <div class="fw-semibold">{{ currentUser?.branch || '' }}</div>
        </div>
        <div class="col-12 col-md-6">
          <div class="text-muted small">Status</div>
          <span
            class="badge"
            [ngClass]="{
              'bg-success-subtle text-success border border-success': currentUser?.status === 'Active',
              'bg-danger-subtle text-danger border border-danger': currentUser?.status === 'Inactive',
              'bg-warning-subtle text-warning border border-warning': currentUser?.status === 'Pending'
            }"
          >
            {{ currentUser?.status || '' }}
          </span>
        </div>
      </div>

      <div class="mt-4 d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" (click)="startEdit(currentUser!)" data-bs-dismiss="offcanvas">
          Edit My Details
        </button>
        <button class="btn btn-primary btn-sm" (click)="goToSettings()" data-bs-dismiss="offcanvas">
          Settings
        </button>
      </div>
    </div>
  </div>

  <!-- ===== ADMIN VIEW ===== -->
  <div *ngIf="activeView === 'admin'">
    <!-- Normal Admin layout (hidden in Existing-only mode) -->
    <ng-container *ngIf="!showExistingOnly; else existingOnlyBlock">
      <!-- Filters -->
      <div class="card mb-3">
        <div class="card-body">
          <form class="row g-3 align-items-center" (submit)="$event.preventDefault()">
            <div class="col-md-6 filter-col d-flex flex-column justify-content-center">
              <label for="searchTerm" class="form-label">Search</label>
              <input
                id="searchTerm"
                #searchInput
                name="searchTerm"
                type="text"
                class="form-control"
                [(ngModel)]="searchTerm"
                (ngModelChange)="onSearchChange($event)"
                (input)="onSearchChange(searchInput.value)"
                placeholder="Search by name, email, branch, or ID"
              />
              <div class="mt-2 d-flex gap-2">
                <button type="button" class="btn btn-sm btn-primary" (click)="onSearchChange(searchInput.value)">
                  Search
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearSearch(searchInput)">
                  Clear
                </button>
              </div>
            </div>
            <div class="col-md-3 mb-4 filter-col role-filter-col d-flex flex-column justify-content-center">
              <label for="roleFilter" class="form-label">Role</label>
              <select
                id="roleFilter"
                class="form-select"
                [(ngModel)]="roleFilter"
                (ngModelChange)="onRoleChange($event)"
                placeholder="select"
              >
                <option value="All">All</option>
                <option value="Officer">Officer</option>
                <option value="Manager">Manager</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
          </form>
        </div>
      </div>

      <!-- User Details -->
      <div class="card mb-3 text-white">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h2 class="h6 mb-0">User Details</h2>
          <button type="button" class="btn btn-outline-dark btn-sm" (click)="clearSelected()">Clear</button>
        </div>
        <div class="card-body">
          <ng-container *ngIf="selectedUser; else emptyDetails">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="text-white small">User ID</div>
                <div class="fw-semibold">{{ selectedUser.userId }}</div>
              </div>
              <div class="col-md-3">
                <div class="text-white small">Name</div>
                <div class="fw-semibold">{{ selectedUser.name }}</div>
              </div>
              <div class="col-md-3">
                <div class="text-white small">Email</div>
                <div class="fw-semibold text-truncate" style="max-width: 240px;">
                  {{ selectedUser.email }}
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-white small">Branch</div>
                <div class="fw-semibold">{{ selectedUser.branch }}</div>
              </div>
              <div class="col-md-3">
                <div class="text-white small">Role</div>
                <div class="fw-semibold">{{ selectedUser.role }}</div>
              </div>
              <div class="col-md-3">
                <div class="text-white small">Status</div>
                <span
                  class="badge"
                  [ngClass]="{
                    'bg-success-subtle text-success border border-success': selectedUser.status === 'Active',
                    'bg-danger-subtle text-danger border border-danger': selectedUser.status === 'Inactive',
                    'bg-warning-subtle text-warning border border-warning': selectedUser.status === 'Pending'
                  }"
                >
                  {{ selectedUser.status }}
                </span>
              </div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="button" class="btn btn-outline-primary btn-sm" (click)="startEdit(selectedUser!)">
                Edit This User
              </button>
            </div>
          </ng-container>

          <ng-template #emptyDetails>
            <div class="text-center text-white py-4">
              <div class="mb-2">No user selected</div>
              <div class="small">Type in the search box or click a user row to view details.</div>
            </div>
          </ng-template>
        </div>
      </div>

      <!-- Pending Approvals -->
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h2 class="h6 mb-0">Pending Approvals</h2>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>User ID</th>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Email</th>
                  <th>Branch</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let u of pendingUsers">
                  <td>{{ u.userId }}</td>
                  <td>{{ u.name }}</td>
                  <td>{{ u.role }}</td>
                  <td class="text-truncate" style="max-width: 280px;">{{ u.email }}</td>
                  <td>{{ u.branch }}</td>
                  <td class="text-end">
                    <!-- Single Proceed button to open modal -->
                    <button
                      type="button"
                      class="btn btn-primary btn-sm"
                      (click)="openProceed(u)"
                      data-bs-toggle="modal"
                      data-bs-target="#proceedModal"
                    >
                      Proceed
                    </button>
                  </td>
                </tr>
                <tr *ngIf="pendingUsers.length === 0">
                  <td colspan="6" class="text-center text-muted py-3">No pending approvals</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Existing-only mode: ONLY show the child component -->
    <ng-template #existingOnlyBlock>
      <app-existing-users-table
        [rows]="existingUsers()"
        (selectUser)="onExistingUserSelected($event)"
        (updateUser)="onExistingUserUpdated($event)"
      ></app-existing-users-table>
    </ng-template>
  </div>

  <!-- ===== COMPLIANCE VIEW ===== -->
  <div *ngIf="activeView === 'compliance'" class="compliance-root">
    <!-- Compliance KPIs -->
    <div class="card mb-3">
      <!-- Optional actions in header -->
      <!--
      <div class="card-header d-flex align-items-center justify-content-between">
        <h2 class="h6 mb-0">KPIs</h2>
        <div class="compliance-actions">
          <button class="btn btn-sm btn-outline-dark" type="button" (click)="showAdmin()">Back to Admin</button>
          <button class="btn btn-sm btn-warning" type="button" (click)="openExistingUsers()">Existing Users</button>
        </div>
      </div>
      -->
      <div class="card-body">
        <div class="row g-3 mb-3 kpis-row">
          <div class="col-12 col-md-4">
            <div class="p-3 border rounded-3 kpi h-100 d-flex flex-column justify-content-between">
              <div class="text-muted small">Total Transactions</div>
              <div class="fs-5 fw-semibold text-white">{{ compliance.totalTransactions | number }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="p-3 border rounded-3 kpi h-100 d-flex flex-column justify-content-between">
              <div class="text-muted small">High-Value Count</div>
              <div class="fs-5 fw-semibold text-white">{{ compliance.highValueCount | number }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="p-3 border rounded-3 kpi h-100 d-flex flex-column justify-content-between">
              <div class="text-muted small">Account Growth Rate</div>
              <div class="fs-5 fw-semibold text-white">{{ compliance.accountGrowthRate | number:'1.0-2' }}%</div>
            </div>
          </div>
        </div>

        <!-- Dual line chart -->
        <div class="chart-block mb-3">
          <div class="container-fluid px-3 px-md-4">
            <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap">
              <h3 class="h6 mb-2 mb-md-0">Monthly Volume vs Suspicious Flags</h3>
              <div class="legend small text-muted d-flex align-items-center gap-3">
                <span class="d-inline-flex align-items-center gap-1">
                  <span class="swatch" style="background:#1976d2;"></span> Transactions
                </span>
                <span class="d-inline-flex align-items-center gap-1">
                  <span class="swatch" style="background:#d32f2f;"></span> Suspicious
                </span>
              </div>
            </div>

            <!-- Chart wrapper reference -->
            <div class="svg-wrap" #chartWrap>
              <svg
                class="svg-chart"
                role="img"
                aria-label="Monthly volume and suspicious"
                [attr.viewBox]="'0 0 ' + chartWidth + ' ' + chartHeight"
                preserveAspectRatio="xMidYMid meet"
              >
                <!-- Y axis ticks & grid -->
                <g class="y-axis" *ngIf="compliance.monthlyTxnVolume.length">
                  <g *ngFor="let t of yTicks()">
                    <line
                      [attr.x1]="chartLeftMargin"
                      [attr.y1]="yPosInPlot(t, chartHeight - 60)"
                      [attr.x2]="chartLeftMargin + plotWidth()"
                      [attr.y2]="yPosInPlot(t, chartHeight - 60)"
                      stroke="rgba(0,0,0,0.06)"
                    />
                    <text
                      [attr.x]="chartLeftMargin - 8"
                      [attr.y]="yPosInPlot(t, chartHeight - 60) + 4"
                      text-anchor="end"
                      font-size="11"
                    >
                      {{ t | number }}
                    </text>
                  </g>
                </g>

                <!-- Move plot area right to make room for Y axis labels -->
                <g [attr.transform]="'translate(' + chartLeftMargin + ',0)'">
                  <!-- baseline -->
                  <line [attr.x1]="0" [attr.y1]="chartHeight - 60" [attr.x2]="plotWidth()" [attr.y2]="chartHeight - 60" stroke="#cfd8dc" />

                  <!-- series -->
                  <path [attr.d]="linePath(compliance.monthlyTxnVolume, plotWidth(), chartHeight - 60)" fill="none" stroke="#1976d2" stroke-width="2"></path>

                  <path [attr.d]="linePath(compliance.monthlySuspicious, plotWidth(), chartHeight - 60)" fill="none" stroke="#d32f2f" stroke-width="2" stroke-dasharray="4 3"></path>

                  <!-- x-axis labels -->
                  <g class="x-labels text-dark">
                    <text
                      *ngFor="let lbl of compliance.monthlyLabels; let i = index"
                      [attr.x]="(plotWidth() / (compliance.monthlyLabels.length - 1)) * i"
                      [attr.y]="chartHeight - 25"
                      text-anchor="middle"
                      font-size="12"
                    >
                      {{ lbl }}
                    </text>
                  </g>
                </g>
              </svg>
            </div>
          </div>
        </div>

        <!-- Amount Buckets -->
        <div class="chart-block mb-3">
          <h3 class="h6 mb-2">Amount Buckets</h3>
          <div class="bars">
            <div class="bar-row" *ngFor="let b of compliance.amountBuckets">
              <div class="bar-label">{{ b.label }}</div>
              <div class="bar-track">
                <div class="bar-fill" [style.width.%]="(b.count / maxBucket) * 100"></div>
              </div>
              <div class="bar-value text-white">{{ b.count | number }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Proceed Modal (for Pending Approvals) ===== -->
  <div
    class="modal fade glass-modal"
    id="proceedModal"
    tabindex="-1"
    aria-labelledby="proceedModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="proceedModalLabel">
            Proceed: {{ pendingSelectedUser?.name || 'User' }}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <ng-container *ngIf="pendingSelectedUser; else noPendingUser">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <div class="text-muted small">User ID</div>
                <div class="fw-semibold text-dark">{{ pendingSelectedUser.userId }}</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted small">Name</div>
                <div class="fw-semibold text-dark">{{ pendingSelectedUser.name }}</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted small">Email</div>
                <div class="fw-semibold text-dark">{{ pendingSelectedUser.email }}</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted small">Branch</div>
                <div class="fw-semibold text-dark">{{ pendingSelectedUser.branch }}</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted small">Role</div>
                <div class="fw-semibold text-dark">{{ pendingSelectedUser.role }}</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted small">Status</div>
                <span
                  class="badge"
                  [ngClass]="{
                    'bg-success-subtle text-success border border-success': pendingSelectedUser.status === 'Active',
                    'bg-danger-subtle text-danger border border-danger': pendingSelectedUser.status === 'Inactive',
                    'bg-warning-subtle text-warning border border-warning': pendingSelectedUser.status === 'Pending'
                  }"
                >
                  {{ pendingSelectedUser.status }}
                </span>
              </div>
            </div>
          </ng-container>
          <ng-template #noPendingUser>
            <div class="text-muted">No user selected.</div>
          </ng-template>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">Close</button>
          <button
            type="button"
            class="btn btn-outline-danger"
            (click)="rejectUser(pendingSelectedUser!)"
            data-bs-dismiss="modal"
          >
            Reject
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="approveUser(pendingSelectedUser!)"
            data-bs-dismiss="modal"
          >
            Approve
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer (optional) -->
</div>

<!-- Optional small styles (component-scoped if using Angular's styles) -->
<style>
  .dropdown-menu.text-sm { font-size: 0.9rem; }
  .avatar-initials { font-weight: 600; letter-spacing: 0.5px; }
  .swatch { display:inline-block; width:12px; height:12px; border-radius:2px; }
  .btn-transparent { background: transparent; border: 0; color: inherit; }
</style>
